<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ColorJam - Visualizador</title>
    <script src="/socket.io/socket.io.js"></script>
    <!-- Solo una librer√≠a de p5.js -->
    <script src="libraries/p5.min.js"></script>
    <!-- p5.sound debe ir despu√©s de p5 -->
    <script src="libraries/p5.sound.min.js"></script>
    <script src="sketch.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: black;
      }

      /* Bot√≥n flotante arriba a la izquierda */
      #connectBtn {
        position: fixed;
        top: 10px;
        left: 10px;
        background: #ff0044;
        border: none;
        border-radius: 8px;
        color: white;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        z-index: 1000;
      }

      #connectBtn:hover {
        background: #ff3366;
      }
    </style>
  </head>

  <body>
    <button id="connectBtn">üîå Conectar micro:bit</button>

    <script>
      // Variables globales accesibles desde sketch.js
      window.microData = { buttonA: false, buttonB: false, shake: false };

      document.getElementById("connectBtn").addEventListener("click", async () => {
        try {
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });
          const reader = port.readable.getReader();
          console.log("‚úÖ micro:bit conectado");
          let buffer = "";

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += new TextDecoder().decode(value);

            // Procesar cada l√≠nea JSON enviada por la micro:bit
            const lines = buffer.split("\n");
            buffer = lines.pop();

            for (let line of lines) {
              try {
                const data = JSON.parse(line.trim());
                window.microData = data; // üëà Esto actualiza los datos globales
              } catch (e) {
                // ignora l√≠neas vac√≠as o corruptas
              }
            }
          }
        } catch (err) {
          console.error("‚ùå Error conectando micro:bit:", err);
          alert("Error conectando al micro:bit. Usa Chrome o Edge y acepta permisos.");
        }
      });
    </script>
  </body>
</html>
 